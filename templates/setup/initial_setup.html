{% extends "base.html" %}
{% block title %}Initial Setup - GSI - Geospatial Indexing{% endblock %}

{% block content %}
<main class="auth-shell">
    <section class="auth-card" style="max-width: 960px;">
        <div class="auth-brand mb-3">
            <h1 class="h4 mb-1">Initial Setup</h1>
            <p class="text-muted mb-0">Configure SQL Server, optional SMTP, and the first admin account.</p>
        </div>

        <form method="post" action="{{ url_for('setup.setup_submit') }}" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-12">
                <h2 class="h6 text-uppercase text-muted mb-1">SQL Server</h2>
            </div>

            <div class="col-md-4">
                <label class="form-label" for="db_driver">ODBC Driver</label>
                {% if odbc_drivers %}
                    <select id="db_driver" name="db_driver" class="form-select" required>
                        {% for driver in odbc_drivers %}
                            <option value="{{ driver }}" {% if driver == default_odbc_driver %}selected{% endif %}>{{ driver }}</option>
                        {% endfor %}
                    </select>
                {% else %}
                    <input id="db_driver" name="db_driver" class="form-control" value="{{ default_odbc_driver }}" required>
                    <div class="form-text text-danger">No installed SQL Server ODBC drivers detected on this host.</div>
                {% endif %}
            </div>
            <div class="col-md-4">
                <label class="form-label" for="db_server">Server</label>
                <input id="db_server" name="db_server" class="form-control" placeholder="localhost\\SQLEXPRESS or 192.168.1.10,1433" required>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="db_name">Database Name</label>
                <input id="db_name" name="db_name" class="form-control" value="GSIEnterprise" required>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="db_user">SQL Username</label>
                <input id="db_user" name="db_user" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="db_password">SQL Password</label>
                <input id="db_password" name="db_password" type="password" class="form-control" required>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="db_encrypt" name="db_encrypt" checked>
                    <label class="form-check-label" for="db_encrypt">Encrypt connection</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="db_trust_cert" name="db_trust_cert" checked>
                    <label class="form-check-label" for="db_trust_cert">Trust server certificate</label>
                </div>
            </div>

            <div class="col-12 mt-2">
                <h2 class="h6 text-uppercase text-muted mb-1">Initial Admin</h2>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="admin_username">Username</label>
                <input id="admin_username" name="admin_username" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="admin_email">Email</label>
                <input id="admin_email" name="admin_email" type="email" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="admin_password">Password</label>
                <input id="admin_password" name="admin_password" type="password" class="form-control" required>
            </div>

            <div class="col-12 mt-2">
                <h2 class="h6 text-uppercase text-muted mb-1">SMTP (Optional)</h2>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="smtp_host">SMTP Host</label>
                <input id="smtp_host" name="smtp_host" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label" for="smtp_port">SMTP Port</label>
                <input id="smtp_port" name="smtp_port" class="form-control" value="587">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="smtp_user">SMTP User</label>
                <input id="smtp_user" name="smtp_user" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label" for="smtp_pass">SMTP Password</label>
                <input id="smtp_pass" name="smtp_pass" type="password" class="form-control">
            </div>
            <div class="col-md-6">
                <label class="form-label" for="smtp_from">SMTP From</label>
                <input id="smtp_from" name="smtp_from" type="email" class="form-control" placeholder="noreply@domain.com">
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="smtp_tls" name="smtp_tls" checked>
                    <label class="form-check-label" for="smtp_tls">Use STARTTLS</label>
                </div>
            </div>

            <div class="col-12 mt-2">
                <h2 class="h6 text-uppercase text-muted mb-1">Application</h2>
            </div>
            <div class="col-md-8">
                <label class="form-label" for="secret_key">Secret Key (optional)</label>
                <input id="secret_key" name="secret_key" class="form-control" placeholder="Leave blank to auto-generate">
            </div>

            <div class="col-12 d-grid mt-2">
                <button class="btn btn-primary" type="submit">Run Initial Setup</button>
            </div>
        </form>
    </section>
</main>
{% endblock %}
